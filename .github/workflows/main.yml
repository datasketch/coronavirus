name: Deploy

on:
  schedule:
    - cron: '0 */2 * * *'
  push:
    branches: 
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Install R
      run: |
        sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9
        sudo add-apt-repository 'deb https://cloud.r-project.org/bin/linux/ubuntu bionic-cran35/'
        sudo apt update
        sudo apt install -y r-base
    - name: Install base dependencies
      run: sudo apt-get update && sudo apt-get install -y build-essential pandoc libcurl4-gnutls-dev libxml2-dev libssl-dev libudunits2-dev libprotobuf-dev protobuf-compiler libjq-dev libv8-dev libgeos-dev libgdal-dev
    - name: Download phantomjs
      run: wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2
    - name: Install phantomjs
      run: |
        sudo tar xjvf phantomjs-2.1.1-linux-x86_64.tar.bz2 -C /usr/local/share/
        sudo ln -f -s /usr/local/share/phantomjs-2.1.1-linux-x86_64/bin/phantomjs /usr/local/bin
        sudo rm phantomjs-2.1.1-linux-x86_64.tar.bz2
    - name: Install needed packages
      run: |
        sudo Rscript -e "install.packages('devtools')"
        sudo Rscript -e "install.packages('tidyverse')"
        sudo Rscript -e "install.packages('webshot')"
        sudo Rscript -e "devtools::install_github('datasketch/geodata')"
        sudo Rscript -e "devtools::install_github('datasketch/homodatum')"
        sudo Rscript -e "devtools::install_github('jpmarindiaz/datafringe')"
        sudo Rscript -e "devtools::install_github('randommonkey/lfltmagic')"
        sudo Rscript -e "devtools::install_github('randommonkey/hgchmagic')"
    - name: Run script
      run: sudo Rscript source_files.R
    - name: Commit changes
      run: |
        git config --local user.name "GitHub Action"
        git config --local user.email action@github.com
        git add .
        git commit --allow-empty -m 'Updated build'
        git push origin master
